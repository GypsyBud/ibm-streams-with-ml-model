{"metadata":{"guid":"932c2eab-9e47-436d-804e-702059a4a534","url":"/v2/streaming_pipelines/932c2eab-9e47-436d-804e-702059a4a534","created_at":"2020-08-08T06:14:17Z","updated_at":"2020-08-11T18:46:35Z","revision":1597171595257},"entity":{"name":"Click Stream example","description":"","project_guid":"9b8fd798-97bf-46dc-baee-5504ce150827","graph":{"doc_type":"pipeline","version":"1.0","json_schema":"http://www.ibm.com/ibm/wdp/flow-v1.0/pipeline-flow-v1-schema.json","id":"","app_data":{"ui_data":{"name":"Click Stream example"}},"primary_pipeline":"primary-pipeline","pipelines":[{"id":"primary-pipeline","runtime":"streams","nodes":[{"id":"messagehubsample_d75jatbke2r","type":"binding","op":"ibm.streams.sources.messagehubsample","outputs":[{"id":"target","schema_ref":"schema0","links":[{"node_id_ref":"freeform_filter_ik3fdn4bc1","port_id_ref":"source"}]}],"parameters":{"topic":"clickStreamSampleData","schema_mapping":[{"name":"click_event_type","type":"string","length":255,"path":"/click_event_type"},{"name":"customer_id","type":"double","path":"/customer_id"},{"name":"time_stamp","type":"timestamp","path":"/time_stamp"},{"name":"total_number_of_distinct_items_in_basket","type":"double","path":"/total_number_of_distinct_items_in_basket"},{"name":"total_number_of_items_in_basket","type":"double","path":"/total_number_of_items_in_basket"},{"name":"total_price_of_basket","type":"double","path":"/total_price_of_basket"},{"name":"product_category","type":"string","length":255,"path":"/product_category"},{"name":"product_name","type":"string","length":255,"path":"/product_name"},{"name":"product_price","type":"double","path":"/product_price"},{"name":"session_duration","type":"double","path":"/session_duration"}]},"app_data":{"ui_data":{"label":"Sample Data","x_pos":-517.303840637207,"y_pos":249.9930419921875}}},{"id":"freeform_filter_ik3fdn4bc1","type":"execution_node","op":"ibm.streams.operations.freeform-filter","outputs":[{"id":"target","schema_ref":"schema1","links":[{"node_id_ref":"code_s5n3h8uitmr","port_id_ref":"source"}]}],"parameters":{"expression":"click_event_type == 'add_to_cart'\n"},"app_data":{"ui_data":{"label":"Filter","x_pos":-131.5522740946854,"y_pos":138.13074611652797}}},{"id":"code_s5n3h8uitmr","type":"execution_node","op":"ibm.streams.operations.code","outputs":[{"id":"target","schema_ref":"schema2","links":[{"node_id_ref":"wml_deployment_cqs620mnwu","port_id_ref":"source"}]}],"parameters":{"code":"#\n# YOU MUST EDIT THE SCHEMA and add all attributes that you are returning as output.\n#\n# Preinstalled Python packages can be viewed from the Settings pane.\n# In the Settings pane you can also install additional Python packages.\n\nimport sys\nimport logging\n\n# Use this logger for tracing or debugging your code:\nlogger = logging.getLogger(__name__)\n# Example:\n#     logger.info('Got to step 2...')\n\n# init() function will be called once on flow initialization\n# @state a Python dictionary object for keeping state. The state object is passed to the process function\ndef init(state):\n    # do something once on flow initialization and save in the state object\n    state['keep_columns'] = ['Baby Food','Diapers','Formula','Lotion','Baby wash','Wipes','Fresh Fruits','Fresh Vegetables','Beer','Wine','Club Soda','Sports Drink','Chips','Popcorn','Oatmeal','Medicines','Canned Foods','Cigarettes','Cheese','Cleaning Products','Condiments','Frozen Foods','Kitchen Items','Meat','Office Supplies','Personal Care','Pet Supplies','Sea Food','Spices']\n    state['empty_cart'] = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]\n    state['customer_carts'] = {}\n    pass\n\n\n# process() function will be invoked on every event tuple\n# @event a Python dictionary object representing the input event tuple as defined by the input schema\n# @state a Python dictionary object for keeping state over subsequent function calls\n# return must be a Python dictionary object. It will be the output of this operator.\n#        Returning None results in not submitting an output tuple for this invocation.\n# You must declare all output attributes in the Edit Schema window.\ndef process(event, state):\n    # Enrich the event, such as by:\n    # event['wordCount'] = len(event['phrase'].split())\n    logger.info(event)\n    # TODO: check for > 0?\n    customer_id = event['customer_id']\n    product_index = state['keep_columns'].index(event['product_name'])\n    try:\n      cart = state['customer_carts'][event['customer_id']]\n    except KeyError:\n      cart = state['empty_cart']\n    if product_index > -1:\n      cart[product_index] = 1\n    state['customer_carts'][event['customer_id']] = cart\n    return { 'customer_id': customer_id, 'cart_list': cart }","schema_mapping":[{"name":"customer_id","type":"double","length":0,"source_elem_name":""},{"name":"cart_list","type":"string","length":0,"source_elem_name":"","target_elem_name":""}]},"app_data":{"ui_data":{"label":"Code","x_pos":-54.316036224365234,"y_pos":358.46855604166245}}},{"id":"wml_deployment_cqs620mnwu","type":"execution_node","op":"ibm.streams.operations.wml-deployment","outputs":[{"id":"target","schema_ref":"schema3","links":[{"node_id_ref":"debug_cm8nczgmjjl","port_id_ref":"source"}]}],"parameters":{"deployment_id":"41943a32-d29e-4104-9f0d-66de26502643","space_id":"381aa3da-7f8e-4e21-9044-0b8a88331bbc","schema_mapping_inputsource":[{"name":"input_cart","type":"array","length":0,"path":"cart_list"}],"input_schema":[{"name":"input_cart","type":"array","nullable":false}],"output_schema":0,"schema_mapping":[{"name":"prediction","type":"double","length":0,"path":"prediction"}]},"app_data":{"ui_data":{"label":"WML Deployment","x_pos":249.31825887665494,"y_pos":236.4259024002165}}},{"id":"debug_cm8nczgmjjl","type":"binding","op":"ibm.streams.targets.debug","parameters":{},"app_data":{"ui_data":{"label":"Debug","x_pos":511.87274169921875,"y_pos":240.77658081054688}}}]}],"schemas":[{"id":"schema0","fields":[{"name":"click_event_type","type":"string"},{"name":"customer_id","type":"double"},{"name":"time_stamp","type":"timestamp"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_price_of_basket","type":"double"},{"name":"product_category","type":"string"},{"name":"product_name","type":"string"},{"name":"product_price","type":"double"},{"name":"session_duration","type":"double"}]},{"id":"schema1","fields":[{"name":"click_event_type","type":"string"},{"name":"customer_id","type":"double"},{"name":"time_stamp","type":"timestamp"},{"name":"total_number_of_distinct_items_in_basket","type":"double"},{"name":"total_number_of_items_in_basket","type":"double"},{"name":"total_price_of_basket","type":"double"},{"name":"product_category","type":"string"},{"name":"product_name","type":"string"},{"name":"product_price","type":"double"},{"name":"session_duration","type":"double"}]},{"id":"schema2","fields":[{"name":"customer_id","type":"double"},{"name":"cart_list","type":"string"}]},{"id":"schema3","fields":[{"name":"prediction","type":"double"}]}]},"engines":{"streams":{"instance_id":1596866495229}},"deploy":{}}}